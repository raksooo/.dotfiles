#!/bin/bash

history_file=~/.local/share/oskar/rofiHistory
rofi_path=$(which rofiHistory)
alias_file=~/.dotfiles/config/aliases

shopt -s expand_aliases
source $alias_file

rofi="rofi -dmenu -p "â€†" -i -width 40"
if [[ $1 ]] && [[ $1 != *"--all"* ]]; then
    rofi="$rofi -mesg $1"
    alt="calc $(echo $1 | sed 's/\=.*$//')\n"
fi

if [[ $* == *--all* ]]; then
    b1=$(ls /usr/local/bin)
    b2=$(ls /usr/bin)
    alt=$(printf "$b1\n$b2")
else
    hst=$(printf "$(cat $history_file)\nrofiHistory --all")
    alt=$(printf "$alt$hst")
fi

result=$(printf "$alt" | $rofi)
if [[ $result != "" ]]; then
    program=$(echo $result | cut -f 1 -d " ")
    type $program &> /dev/null
    if [[ $? -ne 0 ]]; then
        calc=$(python -c "print($result)" 2> /dev/null)
        if [[ $? -eq 0 ]]; then
            rofiHistory "$result=$calc"
        fi
    elif [[ $program != "" ]]; then
        if [[ $result = *[!\ ]* ]] && [[ $result != "rofiHistory"* ]] && [[ $result != "calc "* ]]; then
            newhst=$(printf "$(grep -v -x "$result" $history_file)")
            printf "$result\n$newhst" > $history_file
        fi
        alias $program &> /dev/null
        if [[ $? -ne 0 ]]; then
            $result &> /dev/null &
        else
            $(alias $result | sed "s/alias $result=//" | sed "s/'//g") &> /dev/null &
        fi
        calc=$(python -c "print($result)" 2> /dev/null)
    fi
fi

